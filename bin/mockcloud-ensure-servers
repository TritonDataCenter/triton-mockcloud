#!/bin/bash
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#
# Copyright (c) 2018, Joyent, Inc.
#

#
# Create or delete mock servers to get to the intended number defined by
# `mdata-get mockcloudNumServers`.
#

if [[ -n "$TRACE" ]]; then
    export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
    set -o xtrace
fi
set -o errexit
set -o pipefail

# How many times to retry downloading latest agents shar before giving up
agentsshar_retries=5

export PATH=/opt/triton/mockcloud/bin:/opt/triton/mockcloud/build/node/bin:$PATH


# ---- support functions

function fatal
{
    echo "$0: fatal error: $*"
    exit 1
}

function createServer
{
    node /opt/triton/mockcloud/node_modules/cn-agent/lib/backends/dummy/tools/create-server.js
}

function deleteServer
{
    node /opt/triton/mockcloud/node_modules/cn-agent/lib/backends/dummy/tools/delete-server.js "$@"
}


# ---- mainline

# This should match SERVER_ROOT defined in cn-agent
# https://github.com/joyent/sdc-cn-agent/blob/master/lib/backends/dummy/common.js#L24
DEFAULT_MOCKCLOUD_ROOT=/data/mockcloud
mockcloudRoot=$(mdata-get mockcloudRoot || true)
if [[ -z "$mockcloudRoot" ]]; then
    mockcloudRoot=$DEFAULT_MOCKCLOUD_ROOT
    mdata-put mockcloudRoot "$mockcloudRoot"
fi
SERVER_ROOT=$mockcloudRoot/servers

DCNAME=$(mdata-get sdc:datacenter_name)
DNSDOMAIN=$(mdata-get dnsDomain)
if [[ -z $DCNAME || -z $DNSDOMAIN ]]; then
    echo "FATAL: must have both DC name and DNS domain" >&2
    exit 2
fi

numServers=$(mdata-get mockcloudNumServers)
numCurrServers=0
if [[ -d $SERVER_ROOT ]]; then
    numCurrServers=$(ls $SERVER_ROOT | wc -l)
fi

if [[ $numServers -eq $numCurrServers ]]; then
    echo "Already have $numServers mock servers"
    exit 0
elif [[ $numServers -gt $numCurrServers ]]; then
    echo "Ensuring we have latest agentsshar"
    while [[ ! -f /var/tmp/latest-agentsshar.sh && $agentsshar_retries -gt 0 ]]; do
        curl -o /var/tmp/latest-agentsshar.sh \
            http://assets.$DCNAME.$DNSDOMAIN/extra/agents/latest \
            || rm -f /var/tmp/latest-agentsshar.sh
        agentsshar_retries=$((agentsshar_retries - 1))
    done

    if [[ ! -f /var/tmp/latest-agentsshar.sh ]]; then
        echo "FATAL: Unable to download latest agentshar" >&2
        exit 2
    fi

    echo "Ensuring $numServers mock servers (currently have $numCurrServers)"
    numToCreate=$(( $numServers - $numCurrServers ))
    while [[ $numToCreate -gt 0 ]]; do
        createServer
        numToCreate=$(( $numToCreate - 1 ))
    done
else
    echo "Ensuring $numServers mock servers (currently have $numCurrServers)"
    numToDelete=$(( $numCurrServers - $numServers ))
    while [[ $numToDelete -gt 0 ]]; do
        # Remove the *oldest* server.
        deleteServer "$(ls -t $SERVER_ROOT | tail -1)"
        numToDelete=$(( $numToDelete - 1 ))
    done
fi

# If there is a cn-agent service yet, then restart it.
cnAgentState=$(svcs -Ho fmri cn-agent 2>/dev/null || true)
if [[ -z "$cnAgentState" ]]; then
    true # pass
elif [[ "$cnAgentState" == "maintenance" ]]; then
    echo "Clearing cn-agent service"
    svcadm clear cn-agent
else
    echo "Restarting cn-agent service"
    svcadm restart cn-agent
fi

# Also restart net-agent if it's there.
netAgentState=$(svcs -Ho fmri net-agent 2>/dev/null || true)
if [[ -z "$netAgentState" ]]; then
    true # pass
elif [[ "$netAgentState" == "maintenance" ]]; then
    echo "Clearing net-agent service"
    svcadm clear net-agent
else
    echo "Restarting net-agent service"
    svcadm restart net-agent
fi


exit 0
